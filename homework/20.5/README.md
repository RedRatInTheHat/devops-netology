## Задание

Составьте постмортем на основе реального сбоя системы GitHub в 2018 году.

Информацию о сбое можно изучить по ссылкам ниже:

* [краткое описание на русском языке](https://habr.com/ru/post/427301/);
* [развёрнутое описание на английском языке](https://github.blog/2018-10-30-oct21-post-incident-analysis/).

### Решение

#### Краткое описание

21 октября 22:52 (UTC+0) в сервисах GitHub произошёл сбой, связанный с разделением сети и несогласованностью баз данных, что привело к неправильному отображению данных на сайте.<br/>
Сбой продолжался 24 часа и 11 минут.

#### Предшествующие события

В 22:52 (UTC+0) проводились работы по замене сетевого оборудования.

#### Причина инцидента

При проведении работ на 43 секунды была потеряна связь между сетевым концентратором и дата центром East Coast. За время отсутствия связанности, оркестратор переназначил master-ноду (на датацентр West Coast). При восстановлении доступа к нодам, возникло рассогласование данных между кластерами двух датацентров. При этом нельзя было отключить East Coast совсем, так как для части пользователей возникла бы значительная задержка в работе сервиса.

#### Воздействие

Сбой затронул данные о создаваемых issue и pull request, не затронув данных git-репозиториев.<br/>
Для проведения восстановительных работ также были отключены webhook'и и приостановлена публикация GitHub Pages.<br/>
Во время проведения восстановительных работ пользователи получали неактуальные данные на сайте в связи с чтением данных из реплик, отстающих на несколько часов. Процесс репликации данных также вызывал задержки в работе сайта.

#### Обнаружение

Сбой был обнаружен через 2 минуты после проведения работ, в 22:54. 

#### Реакция

"Дежурные" инженеры (first responder) отреагировали на оповещения систем мониторинга и определили, что проблема в состоянии баз данных. <br> Для предотвращения дальнейших изменений (и расхождений) заблокирована часть функционала (web-hook'и и сборка GitHub Pages); к работе подключены координатор инцидентов и инженеры базы данных.<br/>

#### Восстановление

22 октября было запущено восстановление данных из бэкапов с дальнейшей синхронизацией данных между репликами и возобновлением ожидающих процессов (web-hook'и и сборки страниц GitHub Pages).

Для снижения нагрузки добавлены дополнительные реплики для чтения.

После всех указанных процедур работа сервиса возобновилась, данные были успешно восстановлены.

#### Таймлайн
Далее везде используется время UTC(+0)

21 октября 22:52: проведение работ по замене сетевого оборудования. Разделяется кластер баз данных, после восстановления данных возникает несогласованность данных.

21 октября 22:54: поступают оповещения об ошибках от систем мониторинга. Инженеры видят, что проблема в состоянии баз данных.

21 октября 23:07: для предотвращения дальнейшего расхождения данных заблокированы внутренние инструменты развёртывания.

21 октября 23:11: к работе подключен координатор инцидента.

21 октября 23:13: к работе подключены инженеры базы данных. Проводится анализ и принимается решение о проведении дальнейших работ по восстановлению согласованности кластеров для сохранения данных пользователей и обеспечения доступности.

21 октября 23:19: принято решение об отключении записи мета-данных (данные, касающиеся собственно сервиса, а не git-репозиториев) для обеспечения целостности данных.

22 октября 00:05: разрабатывается план по восстановлению данных.

22 октября 00:41: запущен процесс восстановления баз данных из бэкапов.

22 октября 06:51: несколько кластеров East Coast завершили восстановление, началась репликация данных из West Coast.

22 октября 07:46: пользователям предоставлена развёрнутая информация об инциденте.

22 октября 11:12: завершено восстановление кластеров East Coast.

22 октября 13:15: завершён процесс создания дополнительных реплик для снижения нагрузки на кластеры, ускоряется процесс репликации.

22 октября 16:24: завершён процесс репликации, возобновлены накопившиеся процессы.

22 октября 16:45: проведены работы по оптимизации выполнения процессов, увеличен TTL процессов (иначе их отбрасывало).

22 октября 23:03: все накопившиеся процессы завершили свою работу. Подтверждена корректная работа сервиса и целостность данных.

#### Последующие действия

* Восстановление данных East Coast, не синхронизированных с West Coast.
* Корректировка методов предоставления информации (во время инцидентов несколько раз пользователям предоставлялась неверная информация по ожидаемому времени восстановления из-за неправильных расчётов).
* Изменение работы оркестратора для адекватной работы в случае межрегионального разделения.
* Ускорен переход к новому механизму оповещений о восстановительных работах (на момент инцидента были доступны только статусы: зелёный, жёлтый и красный).
* Ускорено внедрение механизма поддержки избыточного количества объектов для обеспечения стабильной работы при выходе из строя одного дата-центра.
* Принято решение о добавлении тестирования (в большем количестве).
* Принято решение о добавлении "репетиции" подобных инцидентов.
